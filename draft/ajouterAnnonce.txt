// fichier indexÃ© - ajout direct - CP: fa_cle - CSAD: fa_cle, fa_lieu_rdv
procedure ajouterAnnonce(E/S fannonce: Fannonce, E frajet: Ftrajet)
variables
    cr_fannonce : cdc
    tamp_fannonce : Tannonce

debut
    ecrire("|| PUBLIER UNE NOUVELLE ANNONCE ||")

    repeter
        ecrire('Veuillez saisir votre date de dÃ©part :')
        lire(tamp_fannonce.fa_date_dep)
    jusqu a (tamp_fannonce.fa_date_dep > date())

    repeter
        ecrire('Veuillez saisir votre point de dÃ©part :')
        lire(tamp_fannonce.fa_cle.ftra_pointdepart)
        ecrire('Veuillez saisir votre destination :')
        lire(tamp_fannonce.fa_cle.ftra_pointarrive)
    jusqu a (existeTrajet(ftrajet, tamp_fannonce.fa_cle.ftra_pointdepart, tamp_fannonce.fa_cle.ftra_pointarrive))

    repeter
        ecrire('Veuillez saisir un lieu de rendez-vous :')
        lire(tamp_fannonce.fa_lieu_rdv)
    jusqu a (tamp_fannonce.fa_lieu_rdv <> '')

    repeter
        ecrire('Veuillez saisir le nombre de voyageurs souhaitÃ© :')
        lire(tamp_fannonce.fa_place_max)
    jusqu a (tamp_fannonce.fa_place_max >= 1 et tamp_fannonce.fa_place_max <= 4)

    repeter
        ecrire('Veuillez saisir le prix du voyage :')
        lire(tamp_fannonce.fa_prix)
    jusqu a (tamp_fannonce.fa_prix >= 0)

    ouvrir(fannonce, <<mise-a-jour>>, cr_fannonce)
    ecrireDir(fannonce, tamp_fannonce, cr_fannonce)
    fermer(fannonce, cr_fannonce)

fin

// fichier indexÃ© - CP: ftra_cle -> recherche directe
fonction existeTrajet(E ftrajet : Ftrajet, E depart : cdc, E arrive : cdc) : booleen
variables
    tamp_ftrajet : Ttrajet
    cr_ftrajet : cdc
    existe : booleen
    reponse : caractere

debut
    ouvrir(ftrajet, <<lecture>>, cr_ftrajet)
    tamp_ftrajet.ftra_cle.ftra_pointdepart <- depart
    tamp_ftrajet.ftra_cle.ftra_pointarrive <- arrive
    lireDir(ftrajet, tamp_ftrajet, cr_ftrajet)
    si (cr_ftrajet = 'OK') alors
        existe = vrai
    sinon
        repeter
            ecrire('Trajet inexistant. Voulez-vous crÃ©er un nouveau trajet ? O/N')
            lire(reponse)
            si (reponse = 'O') alors
                existe = vrai
            sinon si (reponse = 'N') alors
                existe = faux
            fin si
        jusqu'a (reponse = 'O' ou reponse = 'N')
    fin si
    fermer(ftrajet, cr_ftrajet)
    si (reponse = 'O') alors
        ouvrir(ftrajet, <<mise-a-jour>>, cr_ftrajet)
        ecrireDir(ftrajet, tamp_ftrajet, cr_ftrajet)
        fermer(ftrajet, cr_ftrajet)
    fin si
    retourner existe
fin

QUESTIONS

- Avec deux fichiers
- Avec trois fichiers

Normalement il y a 6 solutions

DISPLAY 'Vous aller renseigner dans un premier temps la date de dÃ©part.'
           PERFORM WITH TEST AFTER UNTIL fa_annee > AA
               DISPLAY 'Veuillez saisir les deux derniers chiffres de l annÃ©e souhaitÃ©e : (aaaa)'
               ACCEPT fa_annee
           END-PERFORM
           DISPLAY fa_annee





                  *>  saisie date de départ
           DISPLAY '|| PUBLIER UNE NOUVELLE ANNONCE ||'
           DISPLAY ' '
           ACCEPT SYS-DATE6 FROM DATE

           DISPLAY 'Vous allez renseigner dans un premier temps la date'
           DISPLAY 'de départ.'
           DISPLAY ' '

           SET fa_annee TO AA

           PERFORM WITH TEST AFTER UNTIL fa_mois >= MM
               DISPLAY "Veuillez saisir le mois souhaité"
               DISPLAY "(entre 1 et 12)"
               ACCEPT fa_mois
           END-PERFORM

           PERFORM WITH TEST AFTER UNTIL fa_jour >= JJ
               DISPLAY "Maintenant, veuillez saisir le jour"
               DISPLAY "(entre 1 et 31)"
               ACCEPT fa_jour
           END-PERFORM

       *>  saisie point de départ et arrivée
       *>  PERFORM WITH TEST AFTER UNTIL fa_lieudepart > 1
               DISPLAY "Veuillez saisir votre point de départ."
               ACCEPT fa_lieudepart
               DISPLAY "Veuillez saisir votre point d'arrivée."
               ACCEPT fa_lieudarrive

               OPEN INPUT ftrajet
               READ ftrajet
               INVALID KEY
               PERFORM WITH TEST AFTER UNTIL wreponse = 'O' OR
               wreponse = 'N' OR wreponse = 'o' OR wreponse = 'n'
                   DISPLAY "Ce trajet n'existe pas encore."
                   DISPLAY "Voulez-vous créer un nouveau trajet ? (O/N)"
                   ACCEPT wreponse
               END-PERFORM

               NOT INVALID KEY
                   DISPLAY "Le trajet existe."
               END-READ
               CLOSE ftrajet.

               *>  ajout d'un nouveau trajet
               OPEN I-O ftrajet
               IF wreponse = 'O' OR wreponse = 'o'  THEN
                   WRITE tamp_ftrajet
                   INVALID KEY DISPLAY "Impossible d'ajouter."
                   NOT INVALID KEY DISPLAY "Ajout effectué."
                   END-WRITE
               END-IF
               CLOSE ftrajet.

               OPEN INPUT ftrajet
           MOVE 1 TO Wfin

           PERFORM WITH TEST AFTER UNTIL Wfin = 0
               READ ftrajet NEXT
               AT END MOVE 0 TO Wfin
               NOT AT END
                   DISPLAY "Départ : ", ftra_pointdepart
                   DISPLAY "Arrivée : ", ftra_pointarrive
               END-READ
           END-PERFORM

           CLOSE ftrajet.


*>  END-PERFORM

       *>  saisie lieu de rendez-vous
           DISPLAY "Veuillez saisir un lieu de rendez-vous"
           ACCEPT fa_lieu_rdv

       *>  saisie nombre de voyageurs
           PERFORM WITH TEST AFTER UNTIL fa_place_max >= 1 AND
           fa_place_max <= 4
               DISPLAY "Veuillez saisir le nombre de voyageurs."
               DISPLAY "(1 à 4)"
               ACCEPT fa_place_max
           END-PERFORM

       *>  saisie prix du voyage
           PERFORM WITH TEST AFTER UNTIL fa_prix >= 5
               DISPLAY "Veuillez saisir le prix du voyage."
               DISPLAY "(5 ou plus)"
               ACCEPT fa_prix
           END-PERFORM

       *>  ecrire dans fannonce


       *> affichage de tous les trajets
           OPEN INPUT ftrajet
           MOVE 1 TO Wfin

           PERFORM WITH TEST AFTER UNTIL Wfin = 0
               READ ftrajet NEXT
               AT END MOVE 0 TO Wfin
               NOT AT END
                   DISPLAY "Départ : " ftra_pointdepart
                   DISPLAY "Arrivée : " ftra_pointarrive
                   DISPLAY " "
               END-READ
           END-PERFORM

           CLOSE ftrajet.
